@page "/"
@page "/generate"
@rendermode InteractiveServer
@using System.Net.Http.Json
@inject HttpClient Http

<MudPaper Class="p-4" Elevation="1">
    <MudText Typo="Typo.h5" Class="mb-2">Problem Statement</MudText>

    <MudTextField @bind-Value="problem"
                  Label="Enter your problem statement"
                  Variant="Variant.Outlined"
                  Lines="6"
                  FullWidth="true" />

    <div class="d-flex mt-3" style="gap:8px;">
        <MudButton Variant="Variant.Filled" Color="Color.Primary"
           Disabled="@isBusy"
           OnClick="GenerateAsync">
    @(isBusy ? "Generating..." : "Generate")
    </MudButton>

    <MudText Class="mt-2">Last action: @lastAction</MudText>

    </div>

    @if (!string.IsNullOrWhiteSpace(error))
    {
        <MudAlert Severity="Severity.Error" Class="mt-3">@error</MudAlert>
    }

    @if (!string.IsNullOrWhiteSpace(response))
    {
        <MudDivider Class="my-3" />
        <MudText Typo="Typo.h6">Response</MudText>
        <MudPaper Outlined="true" Class="p-3 mt-2">
            <pre style="margin:0; white-space:pre-wrap;">@response</pre>
        </MudPaper>
    }
</MudPaper>

@code {
    private string problem = "";
    private string? response;
    private string? error;
    private bool isBusy;
    private string lastAction = "none";


    private async Task GenerateAsync()
{
    lastAction = "clicked";
    error = null;
    response = null;

    if (string.IsNullOrWhiteSpace(problem) || problem.Trim().Length < 10)
    {
        error = "Please enter at least 10 characters.";
        lastAction = "ui validation failed";
        return;
    }

    isBusy = true;

    try
    {
        var apiUrl = "http://localhost:5153/api/generate"; // <-- change port if needed

        var resp = await Http.PostAsJsonAsync(apiUrl,
            new { ProblemStatement = problem });

        if (!resp.IsSuccessStatusCode)
        {
            error = $"API error {(int)resp.StatusCode}: {await resp.Content.ReadAsStringAsync()}";
            lastAction = "api error";
            return;
        }

        var data = await resp.Content.ReadFromJsonAsync<ApiResponse>();
        response = data?.ResponseText ?? "(No response text)";
        lastAction = "api ok";
    }
    catch (Exception ex)
    {
        error = $"Exception: {ex.Message}";
        lastAction = "exception";
    }
    finally
    {
        isBusy = false;
    }
}

    private record ApiResponse(string Id, DateTimeOffset CreatedUtc, string ResponseText);
}
